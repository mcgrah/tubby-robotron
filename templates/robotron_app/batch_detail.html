{% extends "base.html"%}
{% load static %}

{% block pageScript %}
{% endblock %}

{% block title %}{{ batch.project.name }}: {{ batch.name }}{% endblock %}

{% block page_alerts %}

    {% if errors %}
        <div class="alert alert-danger">
            <p>{{  errors }}</p>
        </div>
        {% elif success %}
        <div class="alert alert-success">
            <p>{{ success }}</p>
        </div>
    {% endif %}

{% endblock %}

{% block content %}
    <div aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ batch.project.get_absolute_url }}">{{ batch.project.name }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ batch.name }}</li>
        </ol>
    </div>

    <h2>{{ batch.project.name }}: {{ batch.name }} Details</h2>
    <h4>Characters Overview</h4>
    <div id="two-form">
    {% load i18n widget_tweaks %}

        <div class="container">
            <div class="btn-group">
                <button class="btn btn-outline-primary" type="button" data-toggle="collapse" data-target="#target1" aria-expanded="false">
                    Add Single
                </button>
                <button class="btn btn-outline-primary" type="button" data-parent="#two-form" data-toggle="collapse" data-target="#target2" aria-expanded="false">
                    Import CSV
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="generate_new_sessions()">Generate Sessions</button>
                <button type="button" class="btn btn-outline-primary" onclick="nuke_empty_sessions()">NUKE Sessions</button>
                <button type="button" class="btn btn-outline-primary invisible" onclick="delete_selected_chars()" id="delete-char-btn">Delete Selected</button>
            </div>
        </div>

        <form action="" method="POST">
            {% csrf_token %}
                <div class="panel">
                    {% if form.errors %}
                        <div class="collapse show" id="target1" data-parent="#two-form">
                    {% else %}
                        <div class="collapse" id="target1" data-parent="#two-form">
                    {% endif %}
                        <div class="card card-body">
                        {% if form.non_field_errors %}
                          <div class="alert alert-danger" role="alert">
                            {% for error in form.non_field_errors %}
                              {{ error }}
                            {% endfor %}
                          </div>
                        {% endif %}
                            <div class="form-row">
                                {% for field in form %}
                                    <div class="form-group col-md-2">
                                        <label class="control-label" for="id_{{ field.name }}">{{ field.label }}</label>
                                        {{ field|attr:"class:form-control" }}
                                        {% if field.errors %}
                                            {% for error in field.errors %}
                                                <div class="alert alert-danger">
                                                {{ error }}
                                                </div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="form-row">
                                <button type="submit" class="btn btn-primary">{% trans "Submit" %}</button>
                                <a class="btn btn-primary" href="{{ batch.get_absolute_url }}" role="button">Clear</a>
                                <input type="text" name="single_form" value="1" class="invisible">
                            </div>
                        </div>
                    </div>
                </div>
{#            {% endif %}#}
        </form>

        <form enctype="multipart/form-data" method="POST">
            {% csrf_token %}

                <div class="panel">
                    {% if file_form.errors %}
                        <div class="collapse show" id="target2" data-parent="#two-form">
                    {% else %}
                        <div class="collapse" id="target2" data-parent="#two-form">
                    {% endif %}
                        <div class="card card-body">
                            {% if file_form.non_field_errors %}
                              <div class="alert alert-danger" role="alert">
                                {% for error in file_form.non_field_errors %}
                                  {{ error }}
                                {% endfor %}
                              </div>
                            {% endif %}
                            <div class="form-row">
                            {{ file_form }}
                            </div>
                            <div class="form-row">
                                <button type="submit" class="btn btn-primary">{% trans "Submit" %}</button>
                                <a class="btn btn-primary" href="{{ batch.get_absolute_url }}" role="button">Clear</a>
                                <input type="text" name="csv_import_form" value="1" class="invisible">
                            </div>
                        </div>
                    </div>
                </div>

        </form>
    </div>
    <hr>

    {% if character_list %}
        <table class="table table-borderless table-sm table-hover" id="character-table">
            <tbody>
            <tr>
                <th></th>
                <th scope="col">Character</th>
                <th scope="col">Actor</th>
                <th scope="col">Files</th>
                <th scope="col">Delivery Date</th>
                <th scope="col">Delivery Time</th>
                <th scope="col" colspan="2">Num. of Sessions</th>
            </tr>
            {% for char in character_list %}
                <tr>
                {% if char.session_count == 0 %}
                    <td><input type="checkbox" aria-label="delete_mark" class="delete-char-box" id="{{ char.id }}"></td>
                {% else %}
                    <td></td>
                {% endif %}
                <td>{{ char.name }}</td>
{#                <td>{{ char.actor.surname }} {{ char.actor.name }}</td>#}
                <td>{{ char.actor.name }}</td>
                <td>{{ char.files_count }}</td>
                <td>{{ char.delivery_date|date:"Y-m-d" }}</td>
                <td>{{ char.delivery_time|time:"H:i"  }}</td>
                <td>{{ char.session_count }}</td>
                <td><a href="{{ char.get_absolute_url }}">Manage</a></td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
       <div class="alert alert-info">No characters added to the current batch.</div>
    {% endif %}

    <hr>

    <h4>Sessions Overview</h4>
    {% if session_list %}
        <table class="table table-borderless table-sm table-hover" id="sessions2">
        <thead>
            <tr>
                <th>Character</th>
                <th>Actor</th>
                <th>Day</th>
                <th>Hour</th>
                <th>Duration</th>
                <th>Director</th>
                <th>Translator</th>
            </tr>
        </thead>
        <tbody>
        {% for session in session_list %}
            <tr>
                <td>{{ session.character.name }}</td>
                <td>{{ session.character.actor.name }}</td>
                <td>{{ session.day|date:"d-m-Y"}}</td>
                <td>{{ session.hour|time:"H:i" }}</td>
                <td>{{ session.duration|default_if_none:'' }}</td>
                <td>{{ session.director.name }}</td>
                <td>{{ session.translator.name }}</td>
            </tr>
        {% endfor %}
        </tbody>
        </table>
    {% else %}
       <div class="alert alert-info">No sessions found in the current batch.</div>
    {% endif %}

{% endblock %}

{% block custom_script_end %}
    {{ form.media }}
    <script type="text/javascript" src="{% static "DataTables/datatables.min.js" %}"></script>

    <script type="text/javascript">
        var timeOutHandler;

        function generate_new_sessions(){
            console.log('button clicked');
            $.ajax({
                url:"{% url "generate_new_sessions" batch_id=batch.id %}",
                beforeSend: function(){
                    timeOutHandler = setTimeout(function(){
                        $("#loadMe").modal({
                          backdrop: "static", //remove ability to close modal with click
                          keyboard: false, //remove option to close with keyboard
                          show: true //Display loader!
                        });
                    },1000);

                },
                complete: function(){
                    clearTimeout(timeOutHander);
                    $("#loadMe").modal("hide");
                },
                success:function(){
                    console.log('call successful');
                    window.location.reload();
                },
            })
        }

        function nuke_empty_sessions(){
            console.log('nuke button clicked');
            $.ajax({
                url:"{% url "nuke_empty_sessions" %}",
                beforeSend: function(){
                    timeOutHandler = setTimeout(function(){
                        $("#loadMe").modal({
                          backdrop: "static", //remove ability to close modal with click
                          keyboard: false, //remove option to close with keyboard
                          show: true //Display loader!
                        });
                    },1000);

                },
                complete: function(){
                    clearTimeout(timeOutHander);
                    $("#loadMe").modal("hide");
                },
                success:function(){
                    console.log('nuke call successful');
                    window.location.reload();
                },
            })
        }

        function delete_selected_chars(){
            console.log('delete chars clicked');
            // retrieve ids from checked boxes
            var ids_for_del = '';
            {#//var view_url = "{% url "delete_selected_chars" %}";#}
            //console.log('base url: ',view_url);

            $('#character-table input:checkbox:checked').each(function(){
               console.log('char_id_for_del:', $(this).attr('id'));
                  if(ids_for_del === '') {
                      ids_for_del = '?ids='+$(this).attr('id')
                  } else {
                      ids_for_del = ids_for_del+','+$(this).attr('id')
                  }
            });
            //view_url.searchParams.append('ids',$(this).attr('id'))
            //pass ids to view?
            console.log(ids_for_del);
            tmpurl ="{% url "delete_selected_chars" %}"+ids_for_del;
            console.log(tmpurl);

            $.ajax({
              url:tmpurl,
                cache:false,
                beforeSend: function(){
                    timeOutHandler = setTimeout(function(){
                        $("#loadMe").modal({
                          backdrop: "static", //remove ability to close modal with click
                          keyboard: false, //remove option to close with keyboard
                          show: true //Display loader!
                        });
                    },500);

                },
                complete: function(){
                    clearTimeout(timeOutHander);
                    $("#loadMe").modal("hide");
                },
                success:function(){
                    console.log('del call successful');
                    window.location.reload();
                },
            })
        }

        $(document).ready(function() {

            $("#just_load_please").on("click", function (e) {
                console.log('dbg_btn_clicked');
                e.preventDefault();
                $("#loadMe").modal({
                    backdrop: "static", //remove ability to close modal with click
                    keyboard: false, //remove option to close with keyboard
                    show: true //Display loader!
                });
                setTimeout(function () {
                    $("#loadMe").modal("hide");
                }, 3500);
            });

            $('#sessions2').DataTable();

            $(document).on('change','#character-table input:checkbox', function(){
                if($('#character-table input:checkbox:checked').length > 0){
                    console.log('cbox checked');
                    $('#delete-char-btn').removeClass('invisible')
                } else {
                    console.log('all cboxes unchecked');
                    $('#delete-char-btn').addClass('invisible')
                }
            });
        });

    </script>
{% endblock %}
{% block after_bootstrap %}

{% endblock %}